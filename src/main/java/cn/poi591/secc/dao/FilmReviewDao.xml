<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.poi591.secc.dao.FilmReviewDao">

	<insert id="add" parameterType="cn.poi591.secc.entity.FilmReview">
		INSERT INTO
		`t_film_review`(`film_id`,`user_id`,`score`,`title`,`text`,`is_spoiler`,`is_private`,`create_time`)
		VALUES(#{filmId},#{userId},#{score},#{title},#{text},#{isSpoiler},#{isPrivate},now());
	</insert>

	<select id="findById" resultType="cn.poi591.secc.entity.FilmReview">
		SELECT * FROM `t_film_review`
		WHERE `id`=#{id};
	</select>


	<select id="getFilmScore" parameterType="cn.poi591.secc.entity.Film"
		resultType="cn.poi591.secc.dto.FilmScore">
		SELECT
		COUNT(*) AS `count`,
		AVG(`score`) AS `average`
		FROM
		`t_film_review` WHERE `film_id`=#{id};
	</select>

	<!-- 查找当前电影所有影评 -->
	<select id="findFilmReviewByFilm" parameterType="cn.poi591.secc.entity.Film"
		resultType="cn.poi591.secc.entity.FilmReview">
		SELECT * FROM `t_film_review`
		WHERE LENGTH(`title`)>0 AND
		`film_id`=#{id};
	</select>



	<!-- 获取当前电影的影评总数 -->
	<select id="getFilmReviewCount" parameterType="cn.poi591.secc.entity.Film"
		resultType="java.lang.Integer">
		SELECT COUNT(*) FROM t_film_review WHERE film_id=#{id} AND 
		LENGTH(`title`)>0 AND is_private=FALSE;
	</select>

	<!-- 根据影评找用户 -->
	<select id="findUserByFilmReview" parameterType="cn.poi591.secc.entity.FilmReview"
		resultType="cn.poi591.secc.entity.User">
		SELECT * FROM t_user WHERE id=#{review.user_id};
	</select>

	<!-- 根据用户找到一篇影评 -->
	<select id="findFilmReviewByUser" parameterType="cn.poi591.secc.entity.User"
		resultType="cn.poi591.secc.entity.FilmReview">
		SELECT * FROM t_film_review WHERE user_id=#{id} LIMIT 1;
	</select>
	
	<!-- 选择可以展示在当前电影页面的影评（公开且内容非空） -->
	
	<!-- 获取当前电影的最新影评，需要设置起始位置和项数 -->
	<select id="getFilmReviewAndUserLatest" resultMap="FilmReviewAndUserMap">
		SELECT * FROM t_film_review
		WHERE film_id=#{film.id} AND
		LENGTH(`title`)>0 AND is_private=FALSE
		ORDER BY create_time DESC
		LIMIT #{start},#{offset};
	</select>
	
	<!-- TODO 获取当前电影的最好影评，需要设置起始位置和项数 -->
	<select id="getFilmReviewAndUserList" parameterType="cn.poi591.secc.entity.Film"
		resultMap="FilmReviewAndUserMap">
		SELECT * FROM `t_film_review`
		WHERE `film_id`=#{id} AND
		LENGTH(`title`)>0 AND `is_private`=FALSE;
	</select>
	
	<!-- 影评及其作者的对象 -->
	<resultMap id="FilmReviewAndUserMap" type="cn.poi591.secc.dto.FilmReviewAndUser">
		<!-- 在FilmReview基础上多携带一个User作为作者 -->
		<association property="user" column="user_id"
			select="cn.poi591.secc.dao.UserDao.findById" />
	</resultMap>
	
</mapper>